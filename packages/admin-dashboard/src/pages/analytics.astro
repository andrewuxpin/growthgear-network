---
import AdminLayout from "../layouts/AdminLayout.astro";
---

<AdminLayout title="Analytics">
  <!-- Period Selector -->
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <select id="period-select" class="px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary-500">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
      <select id="site-filter" class="px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary-500">
        <option value="">All Sites</option>
      </select>
    </div>
    <button id="refresh-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      Refresh
    </button>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="p-3 bg-blue-100 rounded-full">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500">Total Page Views</p>
          <p class="text-2xl font-bold text-gray-900" id="stat-views">-</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="p-3 bg-green-100 rounded-full">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500">Avg Daily Views</p>
          <p class="text-2xl font-bold text-gray-900" id="stat-avg">-</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="p-3 bg-purple-100 rounded-full">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500">Top Pages</p>
          <p class="text-2xl font-bold text-gray-900" id="stat-pages">-</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="p-3 bg-orange-100 rounded-full">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500">Active Sites</p>
          <p class="text-2xl font-bold text-gray-900" id="stat-sites">-</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Traffic by Day -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-900">Traffic Over Time</h2>
      </div>
      <div class="p-6">
        <div id="chart-daily" class="h-64 flex items-end space-x-1">
          <p class="text-gray-500 w-full text-center">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Traffic by Site -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-900">Traffic by Site</h2>
      </div>
      <div class="p-6">
        <div id="chart-sites" class="space-y-4">
          <p class="text-gray-500">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Pages -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-900">Top Pages</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Page</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Views</th>
            </tr>
          </thead>
          <tbody id="table-pages" class="divide-y divide-gray-200">
            <tr><td colspan="3" class="px-6 py-4 text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Referrers -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b">
        <h2 class="text-lg font-semibold text-gray-900">Top Referrers</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Views</th>
            </tr>
          </thead>
          <tbody id="table-referrers" class="divide-y divide-gray-200">
            <tr><td colspan="2" class="px-6 py-4 text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<script is:inline>
(function() {
  const API_URL = 'https://growthgear-api.growthgear.workers.dev';
  let currentPeriod = 30;
  let currentSite = '';

  const siteColors = {
    'ai': { bg: 'bg-violet-500', text: 'text-violet-600' },
    'sales': { bg: 'bg-emerald-500', text: 'text-emerald-600' },
    'marketing': { bg: 'bg-orange-500', text: 'text-orange-600' },
    'hub': { bg: 'bg-blue-500', text: 'text-blue-600' },
  };

  const siteNames = {
    'ai': 'AI Insights',
    'sales': 'Sales Mastery',
    'marketing': 'Marketing Edge',
    'hub': 'GrowthGear Hub',
  };

  async function loadAnalytics() {
    const apiKey = localStorage.getItem('admin_api_key');
    if (!apiKey) return;

    try {
      // Load overview
      const overviewRes = await fetch(`${API_URL}/api/analytics/overview?days=${currentPeriod}`, {
        headers: { 'Authorization': `Bearer ${apiKey}` }
      });
      const overview = await overviewRes.json();

      if (overview.success) {
        const data = overview.data;

        // Update stats
        document.getElementById('stat-views').textContent = data.totalViews.toLocaleString();
        document.getElementById('stat-avg').textContent = Math.round(data.totalViews / currentPeriod).toLocaleString();
        document.getElementById('stat-pages').textContent = data.topPages.length;
        document.getElementById('stat-sites').textContent = data.topSites.length;

        // Render daily chart
        renderDailyChart(data.viewsByDay);

        // Render sites chart
        renderSitesChart(data.topSites);

        // Render top pages table
        renderPagesTable(data.topPages);

        // Populate site filter
        populateSiteFilter(data.topSites);
      }

      // Load referrers
      const referrersRes = await fetch(`${API_URL}/api/analytics/referrers?days=${currentPeriod}${currentSite ? `&site_id=${currentSite}` : ''}`, {
        headers: { 'Authorization': `Bearer ${apiKey}` }
      });
      const referrers = await referrersRes.json();

      if (referrers.success) {
        renderReferrersTable(referrers.data);
      }

    } catch (error) {
      console.error('Failed to load analytics:', error);
    }
  }

  function renderDailyChart(viewsByDay) {
    const container = document.getElementById('chart-daily');
    if (!viewsByDay || viewsByDay.length === 0) {
      container.innerHTML = '<p class="text-gray-500 w-full text-center">No data yet</p>';
      return;
    }

    // Reverse to show oldest first
    const data = [...viewsByDay].reverse().slice(-14);
    const maxViews = Math.max(...data.map(d => d.views), 1);

    container.innerHTML = data.map(day => {
      const height = Math.max((day.views / maxViews) * 100, 4);
      const date = new Date(day.date);
      const label = `${date.getMonth() + 1}/${date.getDate()}`;
      return `
        <div class="flex-1 flex flex-col items-center">
          <div class="w-full bg-primary-500 rounded-t transition-all hover:bg-primary-600"
               style="height: ${height}%"
               title="${day.views} views on ${day.date}"></div>
          <span class="text-xs text-gray-500 mt-2">${label}</span>
        </div>
      `;
    }).join('');
  }

  function renderSitesChart(topSites) {
    const container = document.getElementById('chart-sites');
    if (!topSites || topSites.length === 0) {
      container.innerHTML = '<p class="text-gray-500">No data yet</p>';
      return;
    }

    const maxViews = Math.max(...topSites.map(s => s.views), 1);

    container.innerHTML = topSites.map(site => {
      const width = (site.views / maxViews) * 100;
      const colors = siteColors[site.site_id] || { bg: 'bg-gray-500', text: 'text-gray-600' };
      const name = siteNames[site.site_id] || site.site_id;
      return `
        <div>
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium ${colors.text}">${name}</span>
            <span class="text-sm text-gray-500">${site.views.toLocaleString()} views</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="${colors.bg} rounded-full h-3 transition-all" style="width: ${width}%"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderPagesTable(topPages) {
    const tbody = document.getElementById('table-pages');
    if (!topPages || topPages.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-gray-500">No data yet</td></tr>';
      return;
    }

    tbody.innerHTML = topPages.slice(0, 10).map(page => {
      const name = siteNames[page.site_id] || page.site_id;
      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            <span class="text-sm font-medium text-gray-900">${page.path}</span>
          </td>
          <td class="px-6 py-4">
            <span class="text-sm text-gray-500">${name}</span>
          </td>
          <td class="px-6 py-4 text-right">
            <span class="text-sm font-medium text-gray-900">${page.views.toLocaleString()}</span>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderReferrersTable(referrers) {
    const tbody = document.getElementById('table-referrers');
    if (!referrers || referrers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-gray-500">No data yet</td></tr>';
      return;
    }

    tbody.innerHTML = referrers.slice(0, 10).map(ref => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4">
          <span class="text-sm font-medium text-gray-900">${ref.source}</span>
        </td>
        <td class="px-6 py-4 text-right">
          <span class="text-sm font-medium text-gray-900">${ref.views.toLocaleString()}</span>
        </td>
      </tr>
    `).join('');
  }

  function populateSiteFilter(sites) {
    const select = document.getElementById('site-filter');
    const currentValue = select.value;

    // Keep "All Sites" option and add site options
    select.innerHTML = '<option value="">All Sites</option>' +
      sites.map(site => {
        const name = siteNames[site.site_id] || site.site_id;
        return `<option value="${site.site_id}">${name}</option>`;
      }).join('');

    select.value = currentValue;
  }

  // Event listeners
  document.getElementById('period-select')?.addEventListener('change', (e) => {
    currentPeriod = parseInt(e.target.value);
    loadAnalytics();
  });

  document.getElementById('site-filter')?.addEventListener('change', (e) => {
    currentSite = e.target.value;
    loadAnalytics();
  });

  document.getElementById('refresh-btn')?.addEventListener('click', () => {
    loadAnalytics();
  });

  // Initialize
  function init() {
    if (localStorage.getItem('admin_api_key')) {
      loadAnalytics();
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.addEventListener('apiKeySet', () => {
    setTimeout(init, 100);
  });
})();
</script>
